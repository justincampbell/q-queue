#!/usr/bin/env sh

set -euo pipefail
IFS=$'\n\t'
OPTIND=1

qfile="$HOME/.q"

q_help() {
  echo "q-queue v0.1.0"
  echo "github.com/justincampbell/q-queue"
  echo ""
  echo "  Usage:"
  echo "    q [COMMAND]  Queue command to run at a later time in this directory"
  echo ""
}

q_list() {
  cat $qfile
}

q_run() {
  if [ ! -f $qfile ]; then
    echo "No commands queued"
    exit 1
  fi

  cat $qfile | while read line; do
    directory=$(echo $line | cut -f 1 -d " ")
    command=$(echo $line | cut -f 2 -d " ")
    args=$(echo $line | cut -f 3- -d " ")

    echo $line
    (cd $directory && $command $args)
  done

  rm -f $qfile

  exit 0
}

q_write() {
  echo "$PWD	$qcommand" >> $HOME/.q
}

while getopts "hlr" opt; do
  case "$opt" in
    h)
      q_help
      exit
      ;;
    l)
      q_list
      exit
      ;;
    r)
      q_run
      exit
      ;;
  esac
done

shift $((OPTIND-1))

qcommand="$@"

if [ -z "$qcommand" ]; then
  if [ -f "$qfile" ] && grep -iq "	" $qfile; then
    q_list
  else
    q_help
    exit 1
  fi
else
  q_write
fi
